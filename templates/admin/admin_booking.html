{% extends "admin/admin_base.html" %}

{% block content %}

<h4 class="mb-3 font-weight-bold">
    Bookings
    {% if selected_status %}
    <span class="badge badge-info ml-2">
        {{ selected_status }}
    </span>
    {% endif %}
</h4>

<div class="table-responsive">
    <table class="table table-bordered table-hover text-center">
        <thead class="bg-dark text-warning">
            <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Service</th>
                <th>Electrician</th>
                <th>Status</th>
                <th>Amount</th>
                <th>Action</th>
            </tr>
        </thead>

        <tbody>
            {% for b in bookings %}
            <tr>
                <td>{{ b.id }}</td>
                <td>{{ b.booking_date|date:"d M Y" }}</td>

                <td>
                    {{ b.customer.c_fullname }} <br>
                    <small>{{ b.customer.c_contact }}</small>
                </td>

                <td>{{ b.service.s_name }}</td>

                <td>
                    {% if b.electrician %}
                    {{ b.electrician.e_fullname }}
                    {% else %}
                    <span class="text-muted">Not Assigned</span>
                    {% endif %}
                </td>

                <td>
                    {% if b.status == "Pending" %}
                    <span class="badge badge-warning">Pending</span>
                    {% elif b.status == "Assigned" %}
                    <span class="badge badge-info">Assigned</span>
                    {% elif b.status == "Completed" %}
                    <span class="badge badge-success">Completed</span>
                    {% elif b.status == "Paid" %}
                    <span class="badge badge-primary">Paid</span>
                    {% elif b.status == "Cancelled" %}
                    <span class="badge badge-danger">Cancelled</span>
                    {% endif %}
                </td>

                <td>
                    {% if b.total_amount %}
                    ₹{{ b.total_amount }}
                    {% else %}
                    —
                    {% endif %}
                </td>

                <td>
                    {% if b.status == "Pending" %}
                    <button class="btn btn-sm btn-warning" data-toggle="modal" data-target="#assignModal{{ b.id }}">
                        Assign
                    </button>


                    {% elif b.status == "Assigned" %}
                    <span class="text-muted">In Progress</span>

                    {% elif b.status == "Completed" %}
                    <span class="text-muted">Awaiting Payment</span>

                    {% elif b.status == "Paid" %}
                    <span class="text-success font-weight-bold">Closed</span>

                    {% else %}
                    —
                    {% endif %}
                </td>
            </tr>
            <div class="modal fade" id="assignModal{{ b.id }}" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <div class="modal-header bg-dark text-warning">
                            <h5 class="modal-title">Assign Electrician</h5>
                            <button type="button" class="close text-warning" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>

                        <form method="post" action="{% url 'assign_electrician' b.id %}">
                            {% csrf_token %}

                            <div class="modal-body">
                                <p>
                                    <strong>Booking ID:</strong> {{ b.id }} <br>
                                    <strong>Service:</strong> {{ b.service.s_name }} <br>
                                    <strong>Customer:</strong> {{ b.customer.c_fullname }}
                                </p>

                                <div class="form-group">
                                    <label>Select Electrician</label>
                                    <select name="electrician" class="form-control" required>
                                        <option value="">-- Select --</option>
                                        {% for e in electricians %}
                                        <option value="{{ e.id }}" {% if e.status == "Busy" %}disabled{% endif %}>
                                            {{ e.e_fullname }}
                                            {% if e.status == "Busy" %}
                                            (Busy)
                                            {% else %}
                                            (Available)
                                            {% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="submit" class="btn btn-warning">Assign</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                    Cancel
                                </button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>


            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted">
                    No bookings found
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}